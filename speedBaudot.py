#!/usr/bin/env python3# -*- coding: utf-8 -*-import osfrom datetime import datetimefrom importlib import reloadfrom bisect import bisect# import matplotlib.gridspec as gridspec# import matplotlib.patches as patchesimport matplotlib.pyplot as pltimport numpy as npimport pandas as pd#from mpl_toolkits.axes_grid1.inset_locator import inset_axes# from matplotlib import markers# from matplotlib.patches import Rectangle# from pandas.plotting import tableimport config# import fig_proposal as figp# import general_functions as gfunc# import load.load_data as ldat# import load.load_traces as ltra# import old.old_figs as ofig# import itertools# nb description with pandas:# pd.options.display.max_columns = 30#===========================# global setup# NB fig size : 8.5, 11.6 or 17.6 cmanot = True           # to draw the date and name on the bottom of the plotstd_colors = config.std_colors()speed_colors = config.speed_colors()plt.rcParams.update(config.rc_params())paths = config.build_paths()os.chdir(paths['pg'])paths['data'] = os.path.join(paths['owncFig'], 'data')#%%def load_speed_data():    file = 'baudot.csv'    filename = os.path.join(paths['data'], file)    bddf = pd.read_csv(filename)    file = 'neuron_props_speed.xlsx'    filename = os.path.join(paths['data'], 'averageTraces', file)    cgdf = pd.read_excel(filename)    cols = [st.strip() for st in cgdf.columns]    cols = [st.lower() for st in cols]    cols = [st.replace('(', '_') for st in cols]    cols = [st.replace(')', '') for st in cols]    cgdf.columns = cols    return bddf, cgdfdef build_summary(bddf, cgdf):    """    class the number of cells    input = baudot dataframe & centrigabor dataframe    output = summary dataframe (nb of cells, upper interval spped limit)    """    # count number of cells    def class_speed(s):        "return upper limit in class"        lims = range(100, 500, 25)        i = bisect(lims, s)        return(lims[i])    cgdf['optiMax'] = cgdf.speed_isi0.apply(lambda x: class_speed(x))    cgNumb = dict(cgdf.optiMax.value_counts())    bdNumb = dict(bddf.set_index('optiMax'))    summary_df = pd.DataFrame(index=range(100, 525, 25))    summary_df = summary_df.join(pd.DataFrame(bdNumb))    summary_df.columns = ['bd_cells']    summary_df['cg_cells'] = pd.Series(cgNumb)    return summary_dfdef plot_optimal_speed(df):    fig = plt.figure(figsize=(11.6, 5))    ax = fig.add_subplot(111)    # plot vs uppper limit    x = (df.index - 25).to_list()    # x = summary_df.index.to_list()    height_bd = df.bd_cells.values    height_cg = df.cg_cells.values    # replace nan    height_cg = np.nan_to_num(height_cg, 0)    height_bd = np.nan_to_num(height_bd, 0)    width = 25    align='edge'    # ax.bar([_-10 for _ in x], height=height_cg, width=width, align=align,    #        color='tab:gray', edgecolor='k', label='centrigabor')    ax.bar(x, height=height_bd, width=width, align=align,           color='tab:gray', edgecolor='k', alpha = 0.6, label='baudot')    ax.bar(x, height=height_cg, bottom=height_bd, width=width, align=align,           color='w', edgecolor='k', label='centrigabor')    ax.set_xlabel('{} (°/sec)'.format('optimal apparent speed'.title()))    ax.set_ylabel('nb of Cells')    ax.legend()    for spine in ['top', 'right']:        ax.spines[spine].set_visible(False)    fig.tight_layout()    if anot:        date = datetime.now().strftime('%Y-%m-%d %H:%M:%S')        fig.text(0.99, 0.01, 'speedBaudot.py:plot_optimal_speed',                 ha='right', va='bottom', alpha=0.4)        fig.text(0.01, 0.01, date, ha='left', va='bottom', alpha=0.4)    return figplt.close('all')anot=True# if not 'bddf' in globals() and 'cgdf' in globals():#     bddf, cgdf = load_speed_data()try:    bbdf    cgdfexcept:    bddf, cgdf = load_speed_data()    summary_df = build_summary(bddf, cgdf)fig = plot_optimal_speed(summary_df)save = Falseif save:    file = 'optSpeed.pdf'    dirname = os.path.join(paths['owncFig'], 'pythonPreview', 'baudot')    filename = os.path.join(dirname, file)    fig.savefig(filename)#%%def load_bringuier():    filename = os.path.join(paths['data'], 'bringuier.csv')    brdf = pd.read_csv(filename, sep='\t', decimal=',')    brdf.speed_upper = brdf.speed_upper ## * 1000  # 1mm / visual°    return brdftry:    brdfexcept:    brdf = load_bringuier()#%%plt.close('all')def plot_optimal_bringuier(df):    fig = plt.figure()    ax = fig.add_subplot(111)    # replace nan by O    df = df.fillna(0)    #extract & correction for lower limit    x = (df.speed_upper - 0.05).tolist()    x = [round(_, 2) for _ in x]    height_imp = df.impulse.tolist()    height_bar = df.long_bar.tolist()    align = 'edge'    x[-1] = 1.05     # for continuous range    width = max(x)/(len(x) -1)    ax.bar(x, height=height_imp, width=width, align=align,           color='tab:green', edgecolor='k', alpha=0.8, label='impulse')    ax.bar(x, height=height_bar, width=width, align=align, alpha=1,           color='tab:blue', edgecolor='k', label='bar')    ax.set_xlabel('{} (m/s)'.format('propagation speed'.title()))    ax.set_ylabel('nb of Measures')    ax.legend()    ax.text(1.030, 0, '//', ha='center', va='center', backgroundcolor='w')    for spine in ['top', 'right']:        ax.spines[spine].set_visible(False)    fig.tight_layout()    if anot:        date = datetime.now().strftime('%Y-%m-%d %H:%M:%S')        fig.text(0.99, 0.01, 'speedBaudot.py:plot_optimal_bringuier',             ha='right', va='bottom', alpha=0.4)        fig.text(0.01, 0.01, date, ha='left', va='bottom', alpha=0.4)    return figplt.close('all')fig = plot_optimal_bringuier(brdf)save = Falseif save:    file = 'optSpreedBringuier.pdf'    dirname = os.path.join(paths['owncFig'], 'pythonPreview', 'baudot')    filename = os.path.join(dirname, file)    fig.savefig(filename)#%%def plot_both(df1, df2):    # fig = plt.figure(figsize=(11.6, 5))    # ax = fig.add_subplot(211)    fig, axes = plt.subplots(nrows=2, ncols=1, sharex=True, figsize=(8.6, 8))    ax = axes[0]    # plot vs uppper limit    x = (df1.index - 25).to_list()    x = [_/1000 for _ in x]    # x = summary_df.index.to_list()    height_bd = df1.bd_cells.values    height_cg = df1.cg_cells.values    # replace na    height_cg = np.nan_to_num(height_cg, 0)    height_bd = np.nan_to_num(height_bd, 0)    width = (max(x) - min(x))/(len(x) - 1)    align='edge'    # ax.bar([_-10 for _ in x], height=height_cg, width=width, align=align,    #        color='tab:gray', edgecolor='k', label='centrigabor')    ax.bar(x, height=height_bd, width=width, align=align,           color='tab:grey', edgecolor='tab:grey', alpha=0.5,           label='baudot')    ax.bar(x, height=height_cg, width=width, align=align,           color='tab:red', alpha=0.6, edgecolor='tab:red', label='optimal')# bottom=height_cg    ax.set_xlabel('{} (m/s)'.format('estimated speed'.title()))    ax.set_ylabel('nb of Cells')    ax.legend()    for spine in ['top', 'right']:        ax.spines[spine].set_visible(False)    # ax = fig.add_subplot(212)    ax = axes[1]    # replace nan by O    df2 = df2.fillna(0)    #extract & correction for lower limit    x = (df2.speed_upper - 0.05).tolist()    x = [round(_, 2) for _ in x]    height_imp = df2.impulse.tolist()    height_bar = df2.long_bar.tolist()    align = 'edge'    x[-1] = 1.05     # for continuous range    width = max(x)/(len(x) -1)    ax.bar(x, height=height_imp, width=width, align=align,           color='tab:green', edgecolor='green', alpha=0.8, label='impulse')    ax.bar(x, height=height_bar, width=width, align=align, alpha=1,           color='tab:blue', edgecolor='blue', label='bar')    ax.set_xlabel('{} (m/s)'.format('cortical speed'.title()))    ax.set_ylabel('nb of Measures')    ax.legend()    ax.text(1.030, 0, '//', ha='center', va='center', backgroundcolor='w')    for spine in ['top', 'right']:        ax.spines[spine].set_visible(False)    fig.tight_layout()    # ax.set_xlim(0.1, 0.5)    # ax.set_ylim(0, 24)    lims = ax.get_xlim()    ax.set_xlim(0, lims[1])    # #TODO    # append the number of measures    # 140 impulses    # 92 bars    if anot:        date = datetime.now().strftime('%Y-%m-%d %H:%M:%S')        fig.text(0.99, 0.01, 'speedBaudot.py:plot_both',                 ha='right', va='bottom', alpha=0.4)        fig.text(0.01, 0.01, date, ha='left', va='bottom', alpha=0.4)    return figplt.close('all')fig = plot_both(summary_df, brdf)save = Falseif save:    file = 'optSpreedBoth.pdf'    dirname = os.path.join(paths['owncFig'], 'pythonPreview', 'baudot')    filename = os.path.join(dirname, file)    fig.savefig(filename)#%% add pop#/Users/cdesbois/ownCloud/cgFigures/data/averageTracesplt.close('all')file = 'centrigabor_pop_db.xlsx'filename = os.path.join(paths['data'], 'averageTraces', file)df = pd.read_excel(filename)df.columns = [col.lower().strip() for col in df.columns]#%%# TODO# fusionner les bins# ajouter la pop# df2 = brdf# targetbins = (brdf.speed_upper - 0.05).tolist()targetbins = list(np.linspace(0, 1, 21))targetbins = [round(_, 2) for _ in targetbins]plt.close('all')def hist_summary(brdf, summary_df, cgdf, df):    def compute_speed_histo(speeds, bins=40):        #speeds = df.speed/1000        height, x = np.histogram(speeds, bins=bins, range=(0,1))        # normalize        height = height/np.sum(height)        width = (max(x) - min(x))/(len(x) -1)        return x[:-1], height, width    fig, axes = plt.subplots(figsize=(8.6,8), nrows=2, ncols=2,                              sharey=True, sharex=True)    # ax.bar(x[:-1], height, width=width, color='tab:red', alpha=0.6)    axes = axes.flatten()    # bringuier    ax = axes[0]    x = (brdf.speed_upper - 0.05).tolist()    x = [round(_, 2) for _ in x]    # height_imp = df2.impulse.tolist()    height_bar = (brdf.long_bar)/brdf.long_bar.sum().tolist()    align = 'edge'    x[-1] = 1.05     # for continuous range    width = max(x)/(len(x) -1)    # ax.bar(x, height=height_imp, width=width, align=align,    #        color='tab:green', edgecolor='green', alpha=0.8, label='impulse')    ax.bar(x, height=height_bar, width=width, align=align, alpha=1,           color='tab:blue', edgecolor='k', label='bar bringuier')    txt = 'n = 27,\n ({} measures)'.format(brdf.long_bar.sum())    ax.text(x=0.6, y= 0.7, s=txt, va='bottom', ha='left', transform=ax.transAxes)    ax.legend()    # baudot    ax = axes[1]    x = summary_df.index/1000    height = summary_df.bd_cells / summary_df.bd_cells.sum()    width = (max(x) - min(x))/(len(x) -1)    # width = 0.02    ax.bar(x, height, width=width, color='tab:purple', edgecolor='k', alpha=0.8,            label='baudot')    txt = 'n = {}'.format(int(summary_df.bd_cells.sum()))    ax.text(x=0.6, y= 0.7, s=txt, va='bottom', ha='left', transform=ax.transAxes)    ax.legend()    # centripop    ax = axes[2]    ax.bar(*compute_speed_histo(df.speed/1000), color='tab:red', edgecolor='k',           alpha=0.8, label='centrigabor population')    txt = 'n = {}'.format(len(df))    ax.text(x=0.6, y= 0.7, s=txt, va='bottom', ha='left', transform=ax.transAxes)    txt = 'mean ± std : \n {:.2f} ± {:.2f}'.format(        (df.speed/1000).mean(), (df.speed/1000).std())    ax.text(x=0.5, y= 0.5, s=txt, va='bottom', ha='center', color='tab:red',            transform=ax.transAxes)    ax.legend()    # speed pop     ax = axes[3]    ax.bar(*compute_speed_histo(cgdf.speed_isi0/1000), color='tab:orange',            edgecolor='k', alpha=0.8, label='speed population')    txt = 'n = {}'.format(len(cgdf))    ax.text(x=0.6, y= 0.7, s=txt, va='bottom', ha='left', transform=ax.transAxes)    txt = 'mean ± std : \n {:.2f} ± {:.2f}'.format(        (cgdf.speed_isi0/1000).mean(), (cgdf.speed_isi0/1000).std())    ax.text(x=0.5, y= 0.5, s=txt, va='bottom', ha='center',             color='tab:orange', transform=ax.transAxes)    ax.legend()    fig.suptitle('summary for speed')    ax.set_xlim(0,1)    for ax in fig.get_axes():        for spine in ['left', 'top', 'right']:            ax.spines[spine].set_visible(False)            ax.tick_params(left=False, labelleft=False)    for ax in axes[2:]:        ax.set_xlabel('speed (m/s)')    if anot:        date = datetime.now().strftime('%Y-%m-%d %H:%M:%S')        fig.text(0.99, 0.01, 'speedBaudot.py:hist_summary',                 ha='right', va='bottom', alpha=0.4)        fig.text(0.01, 0.01, date, ha='left', va='bottom', alpha=0.4)            fig.tight_layout()    return figfig = hist_summary(brdf, summary_df, cgdf, df)save = Falseif save:    file = 'hist_summary.pdf'    dirname = os.path.join(paths['owncFig'], 'pythonPreview', 'baudot')    filename = os.path.join(dirname, file)    fig.savefig(filename)